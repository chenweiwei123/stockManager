<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金管理系统 - 对接真实接口</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='80'>croin</text></svg>" type="image/svg+xml">

    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        // 设备判断：添加到全局变量上方
        function isMobileDevice() {
            // 综合判断：屏幕宽度 < 768px 或 UA 包含手机特征
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isSmallScreen = window.innerWidth < 768;
            return isMobileUA || isSmallScreen;
        }
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        success: '#ef4444', // 调整：正收益/涨幅为红色
                        danger: '#10b981',  // 调整：负收益/涨幅为绿色
                        warning: '#f59e0b',
                        gray: { 100: '#f3f4f6', 200: '#e5e7eb', 800: '#1f2937' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect { background: rgba(255,255,255,0.2); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.18); }
            .shadow-card { box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
            .text-gradient { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #1a56db, #3b82f6); }
            .bg-gradient-blue { background-image: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
            .chart-container { position: relative; height: 220px; width: 100%; }
            /* 移动端优化样式 */
            .mobile-btn { @apply py-1.5 px-2 text-sm; }
            .mobile-table { @apply text-xs; }

            /* 新增：手机端按钮简化样式 */
            .is-mobile .mobile-simplify-btn {
                @apply px-2 py-1.5 !important; /* 更小的按钮尺寸 */
            }
            .is-mobile .mobile-simplify-btn span {
                display: none !important; /* 隐藏按钮文字 */
            }
            .is-mobile .mobile-simplify-btn i {
                margin-right: 0 !important; /* 移除图标右边距 */
            }
               .is-mobile .search-input-container {
        display: none !important; /* 手机端直接隐藏整个搜索框容器 */
    }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- 全局加载遮罩 -->
    <div id="globalLoading" class="fixed inset-0 bg-black bg-opacity-20 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <i class="fa fa-spinner fa-spin text-3xl text-primary mb-3"></i>
            <p class="text-gray-700">处理中，请稍候...</p>
        </div>
    </div>

    <!-- 登录页面 -->
    <div id="loginPage" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-card w-full max-w-md p-8">
            <div class="text-center mb-8">
                <i class="fa fa-line-chart text-4xl text-primary mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">基金管理系统</h1>
                <p class="text-gray-500 mt-2">对接真实基金接口 | 历史数据持久化</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">账号</label>
                    <input type="text" name="username" placeholder="请输入登录账号"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        value="admin" autocomplete="off">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" name="password" placeholder="请输入登录密码"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        value="123456">
                </div>
                <div class="flex items-center justify-between mt-1">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="rounded text-primary focus:ring-primary">
                        <span class="ml-2 text-sm text-gray-600">记住我</span>
                    </label>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-blue-700 transition-all flex items-center justify-center">
                    <i class="fa fa-sign-in mr-2"></i> 登录系统
                </button>
                <div class="text-center text-sm text-gray-500 mt-4">
                    测试账号：admin/123456 | test/123456
                </div>
            </form>
        </div>
    </div>

    <!-- 基金看板页面（默认隐藏，登录后显示） -->
    <div id="fundDashboard" class="hidden min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-gradient-blue text-white shadow-lg">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fa fa-line-chart text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold">基金管理系统</h1>
                </div>
                <div class="flex items-center space-x-4 flex-wrap justify-center">
                    <div class="text-white flex items-center">
                        <i class="fa fa-user mr-2"></i>
                        <span id="currentUsername">admin</span>
                    </div>
                    <div class="relative">
                            <div class="relative search-input-container"> <!-- 新增 search-input-container 类 -->
                                <input type="text" id="searchInput" placeholder="搜索基金代码/名称..." class="px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary w-full md:w-64">
                                <i class="fa fa-search absolute right-3 top-3 text-gray-400"></i>
                            </div>
                    </div>
                    <!-- 优化：手动记录改为刷新数据按钮 - 添加 mobile-simplify-btn 类 -->
                    <button id="refreshDataBtn" class="bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition-all flex items-center mobile-simplify-btn">
                        <i class="fa fa-refresh mr-2"></i> <span>刷新数据</span>
                    </button>
                    <!-- 新增基金按钮 - 添加 mobile-simplify-btn 类 -->
                    <button id="toggleAddFundBtn" class="bg-white text-primary px-4 py-2 rounded-lg hover:bg-gray-100 transition-all flex items-center mobile-simplify-btn">
                        <i class="fa fa-plus mr-2"></i> <span>新增基金</span>
                    </button>
                    <!-- 退出登录按钮 - 添加 mobile-simplify-btn 类 -->
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all flex items-center mobile-simplify-btn">
                        <i class="fa fa-sign-out mr-2"></i> <span>退出登录</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要内容区域：改为左右分栏（左侧饼图+右侧列表） -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- 数据概览卡片（优化：新增现存本金、调整累计收益逻辑） -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-card p-6 transition-all hover:shadow-lg">
                    <p class="text-gray-500 text-sm font-medium">总基金数/总投入本金</p>
                    <h3 id="totalFunds" class="text-3xl font-bold mt-2 text-gray-800">0/¥0.00</h3>
                </div>
                <div class="bg-white rounded-xl shadow-card p-6 transition-all hover:shadow-lg">
                    <p class="text-gray-500 text-sm font-medium">总现存本金</p>
                    <h3 id="totalCurrentPrincipal" class="text-3xl font-bold mt-2 text-gray-800">¥0.00</h3>
                    <p class="text-gray-500 text-sm mt-1">投入本金+累计收益</p>
                </div>
                <div class="bg-white rounded-xl shadow-card p-6 transition-all hover:shadow-lg">
                    <p class="text-gray-500 text-sm font-medium">今日总收益</p>
                    <h3 id="totalTodayEarn" class="text-3xl font-bold mt-2 text-gray-800">¥0.00</h3>
                    <p class="text-gray-500 text-sm mt-1">现存本金×今日涨幅</p>
                </div>
                <div class="bg-white rounded-xl shadow-card p-6 transition-all hover:shadow-lg">
                    <p class="text-gray-500 text-sm font-medium">累计总收益</p>
                    <h3 id="totalAllEarn" class="text-3xl font-bold mt-2 text-gray-800">¥0.00</h3>
                    <p class="text-gray-500 text-sm mt-1">历史收益+今日收益</p>
                </div>
            </div>

            <!-- 左右分栏：左侧双饼图 + 右侧基金列表 -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- 左侧饼图区域：lg占3列 -->
                <div class="lg:col-span-3 space-y-6">
                    <div class="bg-white rounded-xl shadow-card p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fa fa-pie-chart text-primary mr-2"></i> 基金本金比例
                        </h3>
                        <div class="chart-container">
                            <canvas id="principalPieChart"></canvas>
                        </div>
                    </div>
<!--                    <div class="bg-white rounded-xl shadow-card p-6">-->
<!--                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">-->
<!--                            <i class="fa fa-pie-chart text-primary mr-2"></i> 今日收益分布-->
<!--                        </h3>-->
<!--                        <div class="chart-container">-->
<!--                            <canvas id="todayEarnPieChart"></canvas>-->
<!--                        </div>-->
<!--                    </div>-->
                </div>

                <!-- 右侧基金列表：lg占9列 -->
                <div class="lg:col-span-9">
                    <div class="bg-white rounded-xl shadow-card overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex justify-between items-center flex-wrap gap-4">
                                <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                                    <i class="fa fa-table text-primary mr-2"></i> 我的基金数据
                                </h2>
                                <div class="flex items-center space-x-2">
                                    <!-- 批量删除按钮 -->
                                    <button id="batchDeleteBtn" class="bg-danger text-white px-3 py-1 rounded-lg hover:bg-red-600 text-sm disabled:opacity-50" disabled>
                                        <i class="fa fa-trash mr-1"></i> 批量删除
                                    </button>
                                    <!-- 每页条数 -->
                                    <select id="rowsPerPage" class="bg-gray-100 text-gray-700 px-2 py-1 rounded-lg text-sm focus:outline-none">
                                        <option value="10">10条/页</option>
                                        <option value="20">20条/页</option>
                                        <option value="50">50条/页</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <!-- 全选复选框 -->
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="selectAllFunds" class="rounded text-primary focus:ring-primary">
                                        </th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="fund_code">基金代码 <i class="fa fa-sort ml-1 text-gray-400"></i></th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="fund_name">基金名称 <i class="fa fa-sort ml-1 text-gray-400"></i></th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="invest_principal">投入本金 <i class="fa fa-sort ml-1 text-gray-400"></i></th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="current_principal">现存本金 <i class="fa fa-sort ml-1 text-gray-400"></i></th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" data-sort="total_earn">累计收益 <i class="fa fa-sort ml-1 text-gray-400"></i></th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">今日涨幅</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">今日收益</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">估值更新时间</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="fundTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                                            <i class="fa fa-spinner fa-spin mr-2"></i> 加载基金数据中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between flex-wrap gap-4">
                            <div class="text-sm text-gray-700">
                                显示 <span id="startRange">1</span> 到 <span id="endRange">10</span> 条，共 <span id="totalItems">0</span> 条记录
                            </div>
                            <div class="flex space-x-2">
                                <button id="prevPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50" disabled>上一页</button>
                                <button id="nextPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50" disabled>下一页</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4 text-center text-sm">
                © 2025 基金管理系统 | 对接真实基金估值接口 | 每日数据自动落库 | 收益/涨幅红正绿负
            </div>
        </footer>
    </div>

    <!-- 新增基金模态框（对接真实接口查询） -->
    <div id="addFundModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fa fa-plus-circle text-primary mr-2"></i> 新增基金（真实接口）
                </h3>
                <button id="closeAddFundModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div id="fundSearchStep" class="space-y-4">
                    <div>
                        <label for="searchFundId" class="block text-sm font-medium text-gray-700 mb-1">基金代码 <span class="text-danger">*</span></label>
                        <div class="flex space-x-2">
                            <input type="text" id="searchFundId" placeholder="请输入基金代码（如004253）"
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            <button id="searchFundBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fa fa-search mr-2"></i> 实时查询
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">提示：输入基金代码后实时调用真实接口查询，查询不到将提示基金不存在</p>
                    </div>
                    <div>
                        <label for="fundPrincipal" class="block text-sm font-medium text-gray-700 mb-1">投入本金（¥）<span class="text-danger">*</span></label>
                        <input type="number" id="fundPrincipal" placeholder="请输入投入本金（如1000.00）" step="0.01" min="0.01"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                            value="1000.00">
                    </div>
                    <div id="searchResult" class="hidden p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-medium text-gray-800 mb-3">基金真实信息（实时接口返回）</h4>
                        <div id="fundInfo" class="space-y-2 text-sm grid grid-cols-2 gap-2">
                            <p><strong>基金代码:</strong> <span id="previewId">-</span></p>
                            <p><strong>基金名称:</strong> <span id="previewName">-</span></p>
                            <p><strong>净值日期:</strong> <span id="previewJzrq">-</span></p>
                            <p><strong>单位净值:</strong> <span id="previewDwjz">-</span></p>
                            <p><strong>估值净值:</strong> <span id="previewGsz">-</span></p>
                            <p><strong>今日涨幅:</strong> <span id="previewGszzl">-</span></p>
                            <p><strong>估值更新时间:</strong> <span id="previewGztime">-</span></p>
                            <p><strong>投入本金:</strong> <span id="previewPrincipal" class="text-primary">-</span></p>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button id="confirmAddFund" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fa fa-plus mr-2"></i> 确认添加
                            </button>
                        </div>
                    </div>
                    <div id="searchLoading" class="hidden flex items-center justify-center py-4">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 正在调用真实接口查询基金信息...
                    </div>
                    <div id="searchError" class="hidden p-4 bg-red-50 rounded-lg border border-red-200 text-red-700">
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button id="cancelAddFund" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    取消
                </button>
            </div>
        </div>
    </div>

    <!-- 本金修改模态框 -->
    <div id="updatePrincipalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full mx-4">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fa fa-money text-primary mr-2"></i> 修改基金本金
                </h3>
                <button id="closePrincipalModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="newPrincipal" class="block text-sm font-medium text-gray-700 mb-1">新本金（¥）<span class="text-danger">*</span></label>
                    <input type="number" id="newPrincipal" placeholder="请输入新的投入本金" step="0.01" min="0.01"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <input type="hidden" id="editFundId"> <!-- 存储当前要修改的基金代码 -->
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancelUpdatePrincipal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    取消
                </button>
                <button id="confirmUpdatePrincipal" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    确认修改
                </button>
            </div>
        </div>
    </div>

    <!-- 趋势图模态框（新增：收益+涨幅双折线图） -->
    <div id="trendChartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fa fa-line-chart text-primary mr-2"></i> <span id="trendFundName">基金</span> 趋势图
                </h3>
                <button id="closeTrendModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="chart-container" style="height: 350px; width: 100%;">
                    <canvas id="fundTrendChart"></canvas>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">注：数据为基金添加后分天统计，今日数据为实时计算</p>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button id="cancelTrendModal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript 核心逻辑 - 全量优化适配需求 -->
    <script>
        // 全局变量
        let fundData = [];
        let filteredData = [];
        let currentPageData = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let sortColumn = null;
        let sortDirection = 'asc';
        // 图表实例（防止重复创建）
        let principalPieChart = null;
        let todayEarnPieChart = null;
        let fundTrendChart = null;
        const API_BASE_URL = ''; // 相对路径，前后端同源无跨域
        // 饼图配色（自动循环，适配多基金）
        const CHART_COLORS = [
            'rgba(26, 86, 219, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(16, 185, 129, 0.7)',
            'rgba(245, 158, 11, 0.7)', 'rgba(107, 114, 128, 0.7)', 'rgba(139, 92, 246, 0.7)',
            'rgba(244, 63, 94, 0.7)', 'rgba(21, 128, 61, 0.7)', 'rgba(59, 130, 246, 0.7)'
        ];
        const CHART_BORDER_COLORS = CHART_COLORS.map(c => c.replace('0.7', '1'));

        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (isMobileDevice()) {
                document.body.classList.add('is-mobile');
            } else {
                document.body.classList.add('is-desktop');
            }
            checkLoginStatus(); // 检查是否已登录
            setupLoginEvent();  // 绑定登录事件
            setupDashboardEvent(); // 绑定看板事件
        });

        // ---------------------- 登录相关逻辑 ----------------------
        async function checkLoginStatus() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/current-user`);
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('fundDashboard').classList.remove('hidden');
                    document.getElementById('currentUsername').textContent = data.data.username;
                    // 加载所有核心数据
                    await loadAllData();
                } else {
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('fundDashboard').classList.add('hidden');
                }
            } catch (error) {
                showToast('检查登录状态失败，请刷新页面', 'error');
            }
        }

        function setupLoginEvent() {
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = this.username.value.trim();
                const password = this.password.value.trim();
                if (!username || !password) {
                    showToast('账号和密码不能为空', 'error');
                    return;
                }
                try {
                    showLoading();
                    const res = await fetch(`${API_BASE_URL}/api/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (data.code === 200) {
                        showToast('登录成功，正在进入系统...');
                        setTimeout(() => checkLoginStatus(), 1000);
                    } else {
                        showToast(data.msg || '登录失败', 'error');
                    }
                } catch (error) {
                    showToast('网络错误，请检查后端服务', 'error');
                } finally {
                    hideLoading();
                }
            });
        }

        // ---------------------- 看板事件绑定（新增刷新、趋势图等事件） ----------------------
        function setupDashboardEvent() {
            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                try {
                    showLoading();
                    await fetch(`${API_BASE_URL}/api/logout`);
                    showToast('退出登录成功');
                    checkLoginStatus();
                } catch (error) {
                    showToast('退出失败', 'error');
                } finally {
                    hideLoading();
                }
            });

            // 新增基金按钮
            document.getElementById('toggleAddFundBtn').addEventListener('click', function() {
                document.getElementById('addFundModal').classList.remove('hidden');
                document.getElementById('searchResult').classList.add('hidden');
                document.getElementById('searchError').classList.add('hidden');
            });

            // 关闭/取消新增基金
            document.getElementById('closeAddFundModal').addEventListener('click', () => hideAddModal());
            document.getElementById('cancelAddFund').addEventListener('click', () => hideAddModal());

            // 实时查询基金（对接真实接口）
            document.getElementById('searchFundBtn').addEventListener('click', async () => await searchFund());
            document.getElementById('searchFundId').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') await searchFund();
            });

            // 确认添加基金
            document.getElementById('confirmAddFund').addEventListener('click', async () => await addFundFromSearch());

            // 核心优化：刷新数据按钮（替换原手动记录）
            document.getElementById('refreshDataBtn').addEventListener('click', async function() {
                this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> <span>刷新中...</span>';
                this.disabled = true;
                try {
                    await fetch(`${API_BASE_URL}/api/fund/refresh`);
                    await loadAllData();
                    showToast('数据刷新成功');
                } catch (error) {
                    showToast('刷新失败，请重试', 'error');
                } finally {
                    this.innerHTML = '<i class="fa fa-refresh mr-2"></i> <span>刷新数据</span>';
                    this.disabled = false;
                }
            });

            // 搜索/分页/排序
            document.getElementById('searchInput').addEventListener('input', filterFunds);
            document.getElementById('rowsPerPage').addEventListener('change', function() {
                rowsPerPage = parseInt(this.value);
                currentPage = 1;
                updateTable();
            });
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) { currentPage--; updateTable(); }
            });
            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage < totalPages) { currentPage++; updateTable(); }
            });
            // 表头排序
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => sortTable(th.getAttribute('data-sort')));
            });

            // 本金修改模态框事件
            document.getElementById('closePrincipalModal').addEventListener('click', () => hidePrincipalModal());
            document.getElementById('cancelUpdatePrincipal').addEventListener('click', () => hidePrincipalModal());
            document.getElementById('confirmUpdatePrincipal').addEventListener('click', async () => await updateFundPrincipal());

            // 趋势图模态框事件
            document.getElementById('closeTrendModal').addEventListener('click', () => hideTrendModal());
            document.getElementById('cancelTrendModal').addEventListener('click', () => hideTrendModal());

            // 批量删除相关事件
            document.getElementById('selectAllFunds').addEventListener('change', function() {
                const isChecked = this.checked;
                document.querySelectorAll('.fundItemCheckbox').forEach(cb => {
                    cb.checked = isChecked;
                });
                updateBatchDeleteBtnStatus();
            });
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('fundItemCheckbox')) {
                    updateBatchDeleteBtnStatus();
                }
            });
            document.getElementById('batchDeleteBtn').addEventListener('click', async () => await batchDeleteFunds());
        }

        // ---------------------- 核心数据加载（基金+统计+饼图，统一入口） ----------------------
        async function loadAllData() {
            try {
                showLoading();
                // 并行加载所有数据，提升效率
                const [fundRes, statRes, pieRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/fund/list`),
                    fetch(`${API_BASE_URL}/api/fund/stat`),
                    fetch(`${API_BASE_URL}/api/fund/chart/pie`)
                ]);
                const [fundDataRes, statDataRes, pieDataRes] = await Promise.all([
                    fundRes.json(),
                    statRes.json(),
                    pieRes.json()
                ]);

                // 处理基金列表数据
                if (fundDataRes.code === 200) {
                    fundData = fundDataRes.data || [];
                    filteredData = [...fundData];
                    currentPageData = [...fundData];
                    updateTable();
                }

                // 处理统计数据
                if (statDataRes.code === 200) {
                    updateStatCard(statDataRes.data);
                }

                // 处理饼图数据
                if (pieDataRes.code === 200) {
                    renderPieCharts(pieDataRes.data);
                }

                if (fundDataRes.code === 401 || statDataRes.code === 401 || pieDataRes.code === 401) {
                    checkLoginStatus();
                }
            } catch (error) {
                document.getElementById('fundTableBody').innerHTML = `
                    <tr><td colspan="10" class="px-6 py-8 text-center text-red-500"><i class="fa fa-exclamation-circle mr-2"></i>${error.message}</td></tr>
                `;
                showToast('数据加载失败', 'error');
                console.error('加载数据失败:', error);
            } finally {
                hideLoading();
            }
        }

        // 更新概览统计卡片
        function updateStatCard(stat) {
            document.getElementById('totalFunds').textContent = fundData.length +"/"+`¥${stat.total_invest.toFixed(2)}`;
            document.getElementById('totalCurrentPrincipal').textContent = `¥${stat.total_current.toFixed(2)}`;
            document.getElementById('totalTodayEarn').textContent = `¥${stat.total_today_earn.toFixed(2)}`;
            document.getElementById('totalAllEarn').textContent = `¥${stat.total_total_earn.toFixed(2)}`;

            // 颜色区分：正红负绿
            setNumberColor('totalTodayEarn', stat.total_today_earn);
            setNumberColor('totalAllEarn', stat.total_total_earn);
        }

        // 渲染双饼图（本金比例+今日收益）
        function renderPieCharts(pieData) {
            const { principal_pie, today_earn_pie } = pieData;
            // 销毁旧图表，防止重复渲染
            if (principalPieChart) principalPieChart.destroy();
            if (todayEarnPieChart) todayEarnPieChart.destroy();

            // 1. 本金比例饼图
            const principalLabels = principal_pie.map(item => item.name);
            const principalValues = principal_pie.map(item => item.value);
            principalPieChart = new Chart(document.getElementById('principalPieChart'), {
                type: 'doughnut',
                data: {
                    labels: principalLabels,
                    datasets: [{
                        label: '投入本金(¥)',
                        data: principalValues,
                        backgroundColor: getChartColors(principalLabels.length),
                        borderColor: getChartBorderColors(principalLabels.length),
                        borderWidth: 1,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const pct = principal_pie[context.dataIndex].pct;
                                    return `${context.label}: ¥${value.toFixed(2)} (${pct.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // 2. 今日收益分布饼图
            const earnLabels = today_earn_pie.map(item => item.name);
            const earnValues = today_earn_pie.map(item => item.value);
            todayEarnPieChart = new Chart(document.getElementById('todayEarnPieChart'), {
                type: 'doughnut',
                data: {
                    labels: earnLabels,
                    datasets: [{
                        label: '今日收益(¥)',
                        data: earnValues,
                        backgroundColor: getChartColors(earnLabels.length),
                        borderColor: getChartBorderColors(earnLabels.length),
                        borderWidth: 1,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const pct = today_earn_pie[context.dataIndex].pct;
                                    return `${context.label}: ¥${value.toFixed(2)} (${pct.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // ---------------------- 基金操作接口（新增/删除/修改/趋势图） ----------------------
        async function searchFund() {
            const fundCode = document.getElementById('searchFundId').value.trim();
            const principal = document.getElementById('fundPrincipal').value.trim();
            if (!fundCode) { showToast('请输入基金代码', 'error'); return; }
            if (!principal || parseFloat(principal) <= 0) { showToast('请输入有效本金', 'error'); return; }
            // 显示加载
            document.getElementById('searchLoading').classList.remove('hidden');
            document.getElementById('searchResult').classList.add('hidden');
            document.getElementById('searchError').classList.add('hidden');
            try {
                const res = await fetch(`${API_BASE_URL}/api/fund/query/${fundCode}`);
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    const fund = data.data;
                    // 填充预览信息
                    document.getElementById('previewId').textContent = fund.fundcode;
                    document.getElementById('previewName').textContent = fund.name;
                    document.getElementById('previewJzrq').textContent = fund.jzrq;
                    document.getElementById('previewDwjz').textContent = fund.dwjz.toFixed(4);
                    document.getElementById('previewGsz').textContent = fund.gsz.toFixed(4);
                    document.getElementById('previewGszzl').textContent = formatPercent(fund.gszzl);
                    document.getElementById('previewGztime').textContent = fund.gztime;
                    document.getElementById('previewPrincipal').textContent = `¥${parseFloat(principal).toFixed(2)}`;
                    // 颜色区分涨幅
                    setElementColor('previewGszzl', fund.gszzl);
                    // 存储临时基金信息
                    window.tempFundData = fund;
                    window.tempFundPrincipal = parseFloat(principal);
                    // 显示结果
                    document.getElementById('searchLoading').classList.add('hidden');
                    document.getElementById('searchResult').classList.remove('hidden');
                } else {
                    throw new Error(data.msg || '基金不存在，无法查询');
                }
            } catch (error) {
                document.getElementById('searchLoading').classList.add('hidden');
                document.getElementById('searchError').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        async function addFundFromSearch() {
            if (!window.tempFundData || !window.tempFundPrincipal) return;
            try {
                showLoading();
                const fund = window.tempFundData;
                // 提交添加请求
                const res = await fetch(`${API_BASE_URL}/api/fund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fundcode: fund.fundcode,
                        invest_principal: window.tempFundPrincipal
                    })
                });
                const data = await res.json();
                if (data.code === 200) {
                    showToast(`成功添加基金：${fund.name}`);
                    hideAddModal();
                    await loadAllData();
                } else {
                    throw new Error(data.msg || '添加基金失败');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteFund(fundCode) {
            if (!confirm('确定删除该基金？删除后数据不可恢复！')) return;
            try {
                showLoading();
                const res = await fetch(`${API_BASE_URL}/api/fund/${fundCode}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 200) {
                    showToast('基金删除成功');
                    await loadAllData();
                } else {
                    throw new Error(data.msg || '删除失败');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function batchDeleteFunds() {
            const checkedCbs = document.querySelectorAll('.fundItemCheckbox:checked');
            const fundCodes = Array.from(checkedCbs).map(cb => cb.value);
            if (fundCodes.length === 0) {
                showToast('请选择要删除的基金', 'error');
                return;
            }
            if (!confirm(`确定删除选中的${fundCodes.length}只基金？删除后数据不可恢复！`)) return;

            try {
                showLoading();
                const deletePromises = fundCodes.map(code => fetch(`${API_BASE_URL}/api/fund/${code}`, { method: 'DELETE' }));
                const results = await Promise.all(deletePromises);
                const failed = results.some(res => res.status !== 200);
                if (failed) {
                    throw new Error('部分基金删除失败，请重试');
                }
                showToast(`成功删除${fundCodes.length}只基金`);
                await loadAllData();
                updateBatchDeleteBtnStatus();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateFundPrincipal() {
            const fundCode = document.getElementById('editFundId').value;
            const newPrincipal = parseFloat(document.getElementById('newPrincipal').value);
            if (!fundCode || newPrincipal <= 0) {
                showToast('请输入有效的本金', 'error');
                return;
            }
            try {
                showLoading();
                const res = await fetch(`${API_BASE_URL}/api/fund/${fundCode}/principal`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invest_principal: newPrincipal })
                });
                const data = await res.json();
                if (data.code === 200) {
                    showToast('本金修改成功');
                    hidePrincipalModal();
                    await loadAllData();
                } else {
                    throw new Error(data.msg || '本金修改失败');
                }
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // 新增：打开趋势图模态框并加载数据
        async function openTrendModal(fundCode, fundName) {
            try {
                showLoading();
                document.getElementById('trendFundName').textContent = fundName;
                const res = await fetch(`${API_BASE_URL}/api/fund/chart/trend/${fundCode}`);
                const data = await res.json();
                if (data.code === 200 && data.data.trend_list.length > 0) {
                    renderTrendChart(data.data);
                    document.getElementById('trendChartModal').classList.remove('hidden');
                } else {
                    showToast(data.msg || '暂无趋势数据（添加后未到统计时间）', 'warning');
                }
            } catch (error) {
                showToast('加载趋势图失败', 'error');
                console.error('趋势图加载失败:', error);
            } finally {
                hideLoading();
            }
        }

        // 渲染趋势图（双折线：收益趋势+涨幅趋势）
        function renderTrendChart(trendData) {
            const { fund_name, trend_list } = trendData;
            const dates = trend_list.map(item => item.date);
            const dayEarn = trend_list.map(item => item.day_earn);
            const gszzl = trend_list.map(item => item.gszzl);
            const totalEarn = trend_list.map(item => item.total_earn);

            // 销毁旧图表
            if (fundTrendChart) fundTrendChart.destroy();

            // 创建双Y轴折线图
            fundTrendChart = new Chart(document.getElementById('fundTrendChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '当日收益(¥)',
                            data: dayEarn,
                            borderColor: '#1a56db',
                            backgroundColor: 'rgba(26, 86, 219, 0.1)',
                            tension: 0.2,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: '累计收益(¥)',
                            data: totalEarn,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.2,
                            fill: false,
                            yAxisID: 'y'
                        },
                        {
                            label: '当日涨幅(%)',
                            data: gszzl,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.2,
                            fill: false,
                            yAxisID: 'y1',
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        const value = context.parsed.y;
                                        label += label.includes('涨幅') ? formatPercent(value) : `¥${value.toFixed(2)}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10 } }
                        },
                        y: {
                            title: { display: true, text: '收益(¥)', font: { size: 12 } },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 10 }, callback: v => `¥${v}` }
                        },
                        y1: {
                            title: { display: true, text: '涨幅(%)', font: { size: 12 } },
                            position: 'right',
                            grid: { display: false },
                            ticks: { font: { size: 10 }, callback: v => formatPercent(v) }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // ---------------------- 页面渲染与工具函数 ----------------------
        function updateTable() {
            const tbody = document.getElementById('fundTableBody');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            const end = Math.min(start + rowsPerPage, currentPageData.length);
            const pageData = currentPageData.slice(start, end);
            // 更新分页信息
            document.getElementById('startRange').textContent = currentPageData.length ? start + 1 : 0;
            document.getElementById('endRange').textContent = end;
            document.getElementById('totalItems').textContent = currentPageData.length;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = end >= currentPageData.length;
            // 渲染表格行
            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="px-6 py-8 text-center text-gray-500"><i class="fa fa-info-circle mr-2"></i> 暂无基金数据，点击"新增基金"添加（输入真实基金代码）</td></tr>`;
                return;
            }
            pageData.forEach(fund => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <input type="checkbox" class="fundItemCheckbox rounded text-primary focus:ring-primary" value="${fund.fund_code}">
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono">${fund.fund_code}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${fund.fund_name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">¥${fund.invest_principal.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-primary">¥${fund.current_principal.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${getNumberClass(fund.total_earn)}">¥${fund.total_earn.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${getNumberClass(fund.today_gszzl)}">${formatPercent(fund.today_gszzl)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${getNumberClass(fund.today_earn)}">¥${fund.today_earn.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${fund.today_gztime || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800" title="修改本金" onclick="openPrincipalModal('${fund.fund_code}', ${fund.invest_principal})"><i class="fa fa-edit"></i></button>
                        <button class="text-purple-600 hover:text-purple-800" title="趋势图" onclick="openTrendModal('${fund.fund_code}', '${fund.fund_name}')"><i class="fa fa-line-chart"></i></button>
                        <button class="text-red-600 hover:text-red-800" title="删除" onclick="deleteFund('${fund.fund_code}')"><i class="fa fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // 重置全选框和批量删除按钮
            document.getElementById('selectAllFunds').checked = false;
            updateBatchDeleteBtnStatus();
        }

        function filterFunds() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filteredData = keyword ? fundData.filter(f =>
                f.fund_code.toLowerCase().includes(keyword) || f.fund_name.toLowerCase().includes(keyword)
            ) : [...fundData];
            currentPageData = [...filteredData];
            currentPage = 1;
            updateTable();
        }

        function sortTable(column) {
            if (sortColumn === column) sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            else { sortColumn = column; sortDirection = 'asc'; }
            // 更新排序图标
            document.querySelectorAll('th[data-sort] i').forEach(i => i.className = 'fa fa-sort ml-1 text-gray-400');
            document.querySelector(`th[data-sort="${column}"] i`).className = `fa fa-sort-${sortDirection} ml-1 text-primary`;
            // 排序数据
            currentPageData.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (typeof valA === 'string' && !isNaN(valA)) { valA = parseFloat(valA); valB = parseFloat(valB); }
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                return (valA > valB ? 1 : -1) * (sortDirection === 'asc' ? 1 : -1);
            });
            updateTable();
        }

        // 格式化百分比（正号显示，保留2位小数）
        function formatPercent(num) {
            const n = parseFloat(num) || 0;
            return n > 0 ? `+${n.toFixed(2)}%` : `${n.toFixed(2)}%`;
        }

        // 获取数字颜色类（正红负绿）
        function getNumberClass(num) {
            const n = parseFloat(num) || 0;
            return n > 0 ? 'text-success font-medium' : n < 0 ? 'text-danger font-medium' : 'text-gray-500';
        }

        // 设置元素数字颜色（正红负绿）
        function setElementColor(elId, num) {
            const el = document.getElementById(elId);
            el.className = getNumberClass(num);
        }

        // 设置统计卡片数字颜色
        function setNumberColor(elId, num) {
            const el = document.getElementById(elId);
            el.className = getNumberClass(num) + ' text-3xl font-bold mt-2';
        }

        // 打开本金修改模态框
        function openPrincipalModal(fundCode, currentPrincipal) {
            document.getElementById('editFundId').value = fundCode;
            document.getElementById('newPrincipal').value = currentPrincipal.toFixed(2);
            document.getElementById('updatePrincipalModal').classList.remove('hidden');
        }

        // 隐藏模态框
        function hideAddModal() {
            document.getElementById('addFundModal').classList.add('hidden');
            document.getElementById('searchFundId').value = '';
            document.getElementById('fundPrincipal').value = '1000.00';
            window.tempFundData = null;
            window.tempFundPrincipal = null;
        }

        function hidePrincipalModal() {
            document.getElementById('updatePrincipalModal').classList.add('hidden');
            document.getElementById('editFundId').value = '';
            document.getElementById('newPrincipal').value = '';
        }

        function hideTrendModal() {
            document.getElementById('trendChartModal').classList.add('hidden');
        }

        // 更新批量删除按钮状态
        function updateBatchDeleteBtnStatus() {
            const checkedCount = document.querySelectorAll('.fundItemCheckbox:checked').length;
            document.getElementById('batchDeleteBtn').disabled = checkedCount === 0;
        }

        // 获取饼图配色（自动循环）
        function getChartColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(CHART_COLORS[i % CHART_COLORS.length]);
            }
            return colors;
        }

        function getChartBorderColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(CHART_BORDER_COLORS[i % CHART_BORDER_COLORS.length]);
            }
            return colors;
        }

        // 消息提示
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const icon = type === 'success' ? '<i class="fa fa-check-circle mr-2"></i>' :
                         type === 'error' ? '<i class="fa fa-exclamation-circle mr-2"></i>' :
                         '<i class="fa fa-info-circle mr-2"></i>';
            const bgColor = type === 'success' ? 'bg-gray-800' : type === 'error' ? 'bg-red-800' : 'bg-blue-800';
            toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center transform translate-y-10 opacity-0 transition-all duration-300`;
            toast.innerHTML = `${icon}${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // 加载遮罩
        function showLoading() {
            document.getElementById('globalLoading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('globalLoading').classList.add('hidden');
        }
    </script>
</body>
</html>
